<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçΩÔ∏è How-Dine Crisis: CVP Decision Challenge</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255,255,255,0.95);
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --gold: #fbbf24;
            --restaurant-red: #dc2626;
            --restaurant-gold: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-animation span {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            animation: float 25s linear infinite;
            bottom: -150px;
            border-radius: 50%;
        }

        .bg-animation span:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .bg-animation span:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .bg-animation span:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .bg-animation span:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .bg-animation span:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .bg-animation span:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .bg-animation span:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .bg-animation span:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .bg-animation span:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .bg-animation span:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
        }

        .game-container {
            max-width: 950px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .music-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .music-btn {
            background: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .music-btn:hover {
            transform: scale(1.1);
        }

        header {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .game-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .game-title .logo {
            font-size: 2.5rem;
        }

        .game-title h1 {
            font-size: 1.4rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .game-title p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-item .value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary);
        }

        .stat-item .value.gold {
            color: var(--gold);
        }

        .progress-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .progress-bar-bg {
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #ef4444, #ec4899, #8b5cf6);
            background-size: 300% 100%;
            animation: gradientMove 3s ease infinite;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .scenario-title {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--restaurant-red);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scenario-text {
            font-size: 1rem;
            line-height: 1.9;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 15px;
            border-left: 5px solid var(--accent);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table tr:nth-child(even) {
            background: #f9fafb;
        }

        .data-table tr:hover {
            background: #fef3c7;
        }

        .question-box {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 1.5rem;
            border: 2px solid var(--primary);
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .question-text::before {
            content: '‚ùì';
            font-size: 1.5rem;
        }

        .attempt-info {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .option-btn {
            background: white;
            border: 3px solid #e5e7eb;
            color: var(--text-dark);
            padding: 1.2rem 1.5rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 0.95rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: #f5f3ff;
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.2);
        }

        .option-btn .option-letter {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .option-btn.correct {
            border-color: var(--success);
            background: #d1fae5;
        }

        .option-btn.correct .option-letter {
            background: var(--success);
        }

        .option-btn.wrong {
            border-color: var(--error);
            background: #fee2e2;
        }

        .option-btn.wrong .option-letter {
            background: var(--error);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .feedback-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 1rem;
            overflow-y: auto;
        }

        .feedback-card {
            background: white;
            border-radius: 25px;
            padding: 2.5rem;
            max-width: 600px;
            width: 100%;
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .feedback-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .feedback-title {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 1rem;
        }

        .feedback-score {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 1rem;
            padding: 0.5rem 1.5rem;
            background: #f3f4f6;
            border-radius: 30px;
            display: inline-block;
        }

        .feedback-message {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-muted);
            margin-bottom: 2rem;
            text-align: left;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 12px;
        }

        .next-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 1rem 3rem;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .next-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .intro-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .intro-card {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 3rem;
            max-width: 750px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .intro-logo {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: float-gentle 3s ease-in-out infinite;
        }

        @keyframes float-gentle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .intro-title {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .intro-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .intro-desc {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-dark);
            margin-bottom: 2rem;
            text-align: left;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 15px;
        }

        .intro-rules {
            text-align: left;
            margin-bottom: 2rem;
        }

        .intro-rules h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .intro-rules ul {
            list-style: none;
            padding: 0;
        }

        .intro-rules li {
            padding: 0.5rem 0;
            padding-left: 2rem;
            position: relative;
        }

        .intro-rules li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            color: white;
            border: none;
            padding: 1.2rem 4rem;
            border-radius: 40px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
        }

        .start-btn:hover {
            transform: scale(1.08);
        }

        .final-grade {
            font-size: 4rem;
            font-weight: 900;
            margin: 1rem 0;
        }

        .grade-S { color: #fbbf24; }
        .grade-A { color: #10b981; }
        .grade-B { color: #3b82f6; }
        .grade-C { color: #f59e0b; }
        .grade-F { color: #ef4444; }

        .final-comment {
            font-size: 1rem;
            line-height: 1.8;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 15px;
            margin: 1.5rem 0;
            text-align: left;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .score-item {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .score-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .score-item .value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        #game-area {
            display: none;
        }

        @media (max-width: 768px) {
            .game-container { padding: 1rem; }
            header { flex-direction: column; text-align: center; }
            .stats { justify-content: center; }
            .game-title h1 { font-size: 1.1rem; }
            .intro-title { font-size: 1.5rem; }
            .scenario-title { font-size: 1.2rem; }
            .feedback-card { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="music-control">
        <button class="music-btn" id="music-toggle" onclick="toggleMusic()" title="Play/Pause Music">üîá</button>
    </div>

    <!-- Real Pachelbel Canon in D from Internet Archive (Free) -->
    <audio id="bgMusic" loop>
        <source src="https://archive.org/download/PachelbelCanonInDMajor/Pachelbel_%20Canon%20-%20In%20D%20Major.mp3" type="audio/mpeg">
        <source src="https://archive.org/download/PachelbelCanonInDMajor/Pachelbel_%20Canon%20-%20In%20D%20Major.ogg" type="audio/ogg">
    </audio>

    <div id="intro-screen" class="intro-screen">
        <div class="intro-card">
            <div class="intro-logo">üçΩÔ∏è</div>
            <h1 class="intro-title">How-Dine Crisis: CVP Challenge</h1>
            <p class="intro-subtitle">MBA | Cost & Management Accounting Practice</p>
            
            <div class="intro-desc">
                <strong>üìñ Story Background:</strong><br>
                How-Dine Wedding Banquet Venue, founded in 2002, had established itself as a premium wedding banquet provider with NT$212 million annual revenue and 120 employees. Then COVID-19 struck in early 2020, devastating the wedding industry overnight. Revenue plummeted 48% to just NT$110 million. As CFO, you must use CVP analysis to navigate this crisis!
            </div>

            <div class="intro-rules">
                <h3>üìã Game Rules</h3>
                <ul>
                    <li>Complete <strong>5 levels</strong> based on the CVP exercises</li>
                    <li>First correct attempt earns <strong>100%</strong> of points</li>
                    <li>Second attempt: <strong>80%</strong>, third: <strong>60%</strong>, and so on</li>
                    <li><strong>Calculate first</strong> before answering ‚Äî options contain traps!</li>
                    <li>Click üîá to play Pachelbel's Canon in D üéª</li>
                </ul>
            </div>

            <button class="start-btn" onclick="game.start()">üöÄ Start Challenge</button>
        </div>
    </div>

    <div id="game-area" class="game-container">
        <header>
            <div class="game-title">
                <span class="logo">üçΩÔ∏è</span>
                <div>
                    <h1>How-Dine Crisis: CVP Challenge</h1>
                    <p>People or Profit? Make strategic decisions!</p>
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="label">Level</div>
                    <div class="value" id="level-display">1 / 5</div>
                </div>
                <div class="stat-item">
                    <div class="label">Score</div>
                    <div class="value gold" id="score-display">0</div>
                </div>
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-header">
                <span>üéØ Progress</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <div class="card" id="level-card">
            <span class="level-badge" id="level-badge">üìä Exercise 1</span>
            <h2 class="scenario-title" id="scenario-title">Break-Even Analysis</h2>
            <div class="scenario-text" id="scenario-text"></div>
            <div id="data-section"></div>
            <div class="question-box">
                <div class="attempt-info" id="attempt-info">üéØ Attempt: 1 / Points Available: 100%</div>
                <p class="question-text" id="question-text"></p>
                <div class="options-grid" id="options-grid"></div>
            </div>
        </div>
    </div>

    <div class="feedback-overlay" id="feedback-overlay">
        <div class="feedback-card">
            <span class="feedback-icon" id="feedback-icon">üéâ</span>
            <h2 class="feedback-title" id="feedback-title">Correct!</h2>
            <div class="feedback-score" id="feedback-score">+20 points</div>
            <p class="feedback-message" id="feedback-message"></p>
            <button class="next-btn" id="feedback-btn">Next</button>
        </div>
    </div>

    <script>
        // üéµ Real Pachelbel Canon in D - from Internet Archive
        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('music-toggle');
        let musicPlaying = false;

        function toggleMusic() {
            if (musicPlaying) {
                bgMusic.pause();
                musicBtn.textContent = 'üîá';
            } else {
                bgMusic.volume = 0.4; // 40% volume for background
                bgMusic.play().catch(e => {
                    console.log('Audio play failed:', e);
                    // Fallback: try again on user interaction
                });
                musicBtn.textContent = 'üîä';
            }
            musicPlaying = !musicPlaying;
        }

        // Level Data based on Teaching Guide CVP Exercises
        const levels = [
            {
                id: 1,
                title: "üè® Exercise 1: Break-Even Point Analysis",
                badge: "üìä Exercise 1: Break-Even Analysis",
                points: 20,
                scenario: `
                    <strong>üìÖ March 2020 - The Crisis Begins</strong><br><br>
                    You are How-Dine's CFO. The pandemic has devastated the wedding industry. Nearly all bookings from late January through July were cancelled. You need to analyze the financial situation to advise Chairman Yeh on critical decisions.
                `,
                dataHtml: `
                    <table class="data-table">
                        <tr><th>Item</th><th>Amount (NT$)</th></tr>
                        <tr><td>Annual Revenue (2018 Baseline)</td><td>$212,050,000</td></tr>
                        <tr><td>Variable Costs (ingredients, part-time staff)</td><td>~38% of revenue</td></tr>
                        <tr><td>Contribution Margin Ratio</td><td>62%</td></tr>
                        <tr><td>Annual Fixed Costs</td><td>$108,000,000</td></tr>
                        <tr><td>2020 Projected Revenue (post-pandemic)</td><td>$110,000,000 (48% decline)</td></tr>
                    </table>
                `,
                question: "What is the annual break-even revenue for How-Dine? With 2020 projected revenue of NT$110M, what is the expected annual loss?",
                options: [
                    { 
                        text: "Break-even: ~NT$174M; Annual loss: ~NT$40M", 
                        isCorrect: true, 
                        feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê Calculation:<br>‚Ä¢ Break-even Revenue = Fixed Costs √∑ CM Ratio<br>= 108,000,000 √∑ 62% = <strong>NT$174,193,548 ‚âà NT$174M</strong><br><br>‚Ä¢ Annual Loss = Fixed Costs - (Revenue √ó CM Ratio)<br>= 108,000,000 - (110,000,000 √ó 62%)<br>= 108,000,000 - 68,200,000 = <strong>NT$39,800,000 ‚âà NT$40M</strong><br><br>‚Ä¢ Monthly Loss = 39,800,000 √∑ 12 ‚âà <strong>NT$3.32M/month</strong><br>(Consistent with the case's NT$3-4M monthly loss description)" 
                    },
                    { 
                        text: "Break-even: ~NT$284M; Annual loss: ~NT$68M", 
                        isCorrect: false, 
                        feedback: "‚ùå You divided by the Variable Cost Ratio (38%) instead of the Contribution Margin Ratio (62%). Break-even = Fixed Costs √∑ <strong>CM Ratio</strong>." 
                    },
                    { 
                        text: "Break-even: ~NT$174M; Annual loss: ~NT$102M", 
                        isCorrect: false, 
                        feedback: "‚ùå Break-even is correct, but loss calculation is wrong. Loss = Fixed Costs - Contribution Margin, not Fixed Costs - Revenue." 
                    },
                    { 
                        text: "Break-even: ~NT$108M; Annual loss: ~NT$0", 
                        isCorrect: false, 
                        feedback: "‚ùå Fixed costs ‚â† Break-even point! You must divide fixed costs by CM ratio to account for how much each dollar contributes to covering those costs." 
                    }
                ]
            },
            {
                id: 2,
                title: "‚ö° Exercise 2: Scenario A - Layoffs + Salary Cut",
                badge: "üíº Exercise 2A: Cash Burn Analysis",
                points: 20,
                scenario: `
                    <strong>üìÖ Strategic Planning Meeting</strong><br><br>
                    Chairman Yeh is considering different strategies. You need to analyze <strong>Scenario A: 50% Layoffs + 20% Salary Reduction</strong> to understand how long the company can survive under this most aggressive cost-cutting approach.
                `,
                dataHtml: `
                    <table class="data-table">
                        <tr><th>Item</th><th>Original / Calculation</th></tr>
                        <tr><td>Cash Reserves</td><td>NT$72,000,000</td></tr>
                        <tr><td>Original Monthly Fixed Costs</td><td>NT$9,000,000</td></tr>
                        <tr><td>„ÄÄ‚îú Full-time Salaries (45 staff)</td><td>NT$4,500,000/month</td></tr>
                        <tr><td>„ÄÄ‚îú Rent</td><td>NT$1,250,000/month</td></tr>
                        <tr><td>„ÄÄ‚îú Utilities</td><td>NT$800,000/month</td></tr>
                        <tr><td>„ÄÄ‚îî Other Fixed Expenses</td><td>NT$2,450,000/month</td></tr>
                        <tr><td>Monthly Contribution Margin (2020)</td><td>110M √∑ 12 √ó 62% = NT$5,683,333</td></tr>
                        <tr><td colspan="2"><strong>Scenario A Adjustments:</strong></td></tr>
                        <tr><td>After 50% layoffs, salary becomes</td><td>4,500,000 √ó 50% = NT$2,250,000</td></tr>
                        <tr><td>After 20% salary cut</td><td>2,250,000 √ó 80% = NT$1,800,000</td></tr>
                        <tr><td>One-time severance (6 months)</td><td>2,250,000 √ó 6 = NT$13,500,000</td></tr>
                    </table>
                `,
                question: "Under Scenario A, what is the new monthly loss and how many months can the cash reserves last (after paying severance)?",
                options: [
                    { 
                        text: "Monthly loss: ~NT$620K; Cash runway: ~95 months", 
                        isCorrect: true, 
                        feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê Calculation:<br>‚Ä¢ New monthly fixed costs = 1,800,000 + 1,250,000 + 800,000 + 2,450,000 = <strong>NT$6,300,000</strong><br><br>‚Ä¢ Monthly loss = 6,300,000 - 5,683,333 = <strong>NT$616,667 ‚âà NT$620K</strong><br><br>‚Ä¢ Cash after severance = 72,000,000 - 13,500,000 = NT$58,500,000<br><br>‚Ä¢ Cash runway = 58,500,000 √∑ 616,667 ‚âà <strong>95 months (~8 years)</strong><br><br>üí° This is the most financially conservative approach, but at what cost to the team?" 
                    },
                    { 
                        text: "Monthly loss: ~NT$620K; Cash runway: ~117 months", 
                        isCorrect: false, 
                        feedback: "‚ùå You forgot to deduct the one-time severance payment of NT$13.5M from the cash reserves before calculating runway!" 
                    },
                    { 
                        text: "Monthly loss: ~NT$2.7M; Cash runway: ~22 months", 
                        isCorrect: false, 
                        feedback: "‚ùå You didn't apply the salary reductions correctly. After 50% layoffs AND 20% pay cut, salaries become NT$1.8M, not NT$4.5M." 
                    },
                    { 
                        text: "Monthly loss: ~NT$1.07M; Cash runway: ~55 months", 
                        isCorrect: false, 
                        feedback: "‚ùå Check your fixed cost calculation. New fixed costs = New salaries + Rent + Utilities + Other = 1.8M + 1.25M + 0.8M + 2.45M = 6.3M" 
                    }
                ]
            },
            {
                id: 3,
                title: "ü§ù Exercise 2: Scenarios C & D Comparison",
                badge: "üíº Exercise 2B: Strategy Comparison",
                points: 20,
                scenario: `
                    <strong>üìÖ The People-First Options</strong><br><br>
                    Now analyze the two options that prioritize employee retention:<br>
                    <strong>Scenario C:</strong> No Layoffs + 20% Salary Reduction<br>
                    <strong>Scenario D:</strong> No Layoffs + No Salary Cuts<br><br>
                    Chairman Yeh inherited a people-first philosophy from his father. Which option aligns better with different time horizons?
                `,
                dataHtml: `
                    <table class="data-table">
                        <tr><th>Scenario</th><th>Monthly Fixed Costs</th><th>Formula</th></tr>
                        <tr><td>C: No Layoffs + 20% Cut</td><td>Salaries: 4.5M √ó 80% = NT$3.6M</td><td>3.6M + 1.25M + 0.8M + 2.45M</td></tr>
                        <tr><td>D: No Layoffs + Full Salary</td><td>Salaries: NT$4.5M (unchanged)</td><td>4.5M + 1.25M + 0.8M + 2.45M</td></tr>
                        <tr><td colspan="3">Monthly Contribution Margin = NT$5,683,333 | Cash Reserves = NT$72,000,000</td></tr>
                    </table>
                `,
                question: "Calculate the monthly loss and cash runway for both Scenario C and Scenario D. Which statement is correct?",
                options: [
                    { 
                        text: "Scenario C: Loss ~NT$2.42M, ~30 months; Scenario D: Loss ~NT$3.32M, ~22 months", 
                        isCorrect: true, 
                        feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê <strong>Scenario C Calculation:</strong><br>‚Ä¢ Fixed costs = 3,600,000 + 1,250,000 + 800,000 + 2,450,000 = NT$8,100,000<br>‚Ä¢ Monthly loss = 8,100,000 - 5,683,333 = <strong>NT$2,416,667 ‚âà NT$2.42M</strong><br>‚Ä¢ Cash runway = 72,000,000 √∑ 2,416,667 ‚âà <strong>30 months (2.5 years)</strong><br><br>üìê <strong>Scenario D Calculation:</strong><br>‚Ä¢ Fixed costs = NT$9,000,000 (unchanged)<br>‚Ä¢ Monthly loss = 9,000,000 - 5,683,333 = <strong>NT$3,316,667 ‚âà NT$3.32M</strong><br>‚Ä¢ Cash runway = 72,000,000 √∑ 3,316,667 ‚âà <strong>22 months (~2 years)</strong><br><br>üí° Scenario D is riskier but preserves maximum employee loyalty and capability." 
                    },
                    { 
                        text: "Scenario C: Loss ~NT$3.32M, ~22 months; Scenario D: Loss ~NT$2.42M, ~30 months", 
                        isCorrect: false, 
                        feedback: "‚ùå You've swapped the scenarios! Scenario D (full salary) has higher costs than Scenario C (20% cut)." 
                    },
                    { 
                        text: "Scenario C: Loss ~NT$1.52M, ~47 months; Scenario D: Loss ~NT$2.42M, ~30 months", 
                        isCorrect: false, 
                        feedback: "‚ùå Check Scenario C's fixed cost calculation. With 20% salary cut: 4.5M √ó 80% = 3.6M, then add other fixed costs." 
                    },
                    { 
                        text: "Scenario C: Loss ~NT$2.42M, ~30 months; Scenario D: Loss ~NT$4.22M, ~17 months", 
                        isCorrect: false, 
                        feedback: "‚ùå Scenario C is correct, but Scenario D's loss is too high. Monthly loss = Fixed costs (9M) - CM (5.68M) = 3.32M, not 4.22M." 
                    }
                ]
            },
            {
                id: 4,
                title: "üç± Exercise 3: NT$138 Bento Box Analysis",
                badge: "ü•° Exercise 3: New Product CVP",
                points: 20,
                scenario: `
                    <strong>üìÖ Innovation During Crisis</strong><br><br>
                    To keep employees working and maintain customer relationships, How-Dine considers launching a NT$138 premium bento box program. Even if it doesn't make money, it might serve other strategic purposes. Analyze the numbers.
                `,
                dataHtml: `
                    <table class="data-table">
                        <tr><th>Item</th><th>Amount</th></tr>
                        <tr><td>Selling Price</td><td>NT$138/unit</td></tr>
                        <tr><td>Ingredient Cost</td><td>~NT$95/unit</td></tr>
                        <tr><td>Packaging Cost</td><td>~NT$8/unit</td></tr>
                        <tr><td>Additional Monthly Fixed Costs (marketing, delivery)</td><td>~NT$50,000</td></tr>
                    </table>
                `,
                question: "What is the contribution margin per bento box? How many must be sold monthly to break even? If only 1,000 are sold, what is the program's P/L?",
                options: [
                    { 
                        text: "CM: NT$35/box; Break-even: 1,429 boxes; 1,000 sold = NT$15,000 loss", 
                        isCorrect: true, 
                        feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê Calculation:<br>‚Ä¢ Contribution Margin = 138 - (95 + 8) = 138 - 103 = <strong>NT$35/box</strong><br><br>‚Ä¢ Break-even Volume = 50,000 √∑ 35 = <strong>1,429 boxes/month</strong><br><br>‚Ä¢ If 1,000 sold: P/L = (1,000 √ó 35) - 50,000 = 35,000 - 50,000 = <strong>-NT$15,000</strong><br><br>üí° <strong>Strategic Insight:</strong> This program loses NT$15K/month on its own, BUT it keeps employees working, maintains brand exposure, sustains customer relationships, and boosts morale. Sometimes short-term losses create long-term value!" 
                    },
                    { 
                        text: "CM: NT$43/box; Break-even: 1,163 boxes; 1,000 sold = NT$7,000 loss", 
                        isCorrect: false, 
                        feedback: "‚ùå You forgot the packaging cost! Variable cost = Ingredients + Packaging = 95 + 8 = NT$103" 
                    },
                    { 
                        text: "CM: NT$35/box; Break-even: 2,857 boxes; 1,000 sold = NT$65,000 loss", 
                        isCorrect: false, 
                        feedback: "‚ùå CM is correct, but break-even is wrong. Break-even = Fixed Costs √∑ Unit CM = 50,000 √∑ 35 = 1,429 boxes" 
                    },
                    { 
                        text: "CM: NT$30/box; Break-even: 1,667 boxes; 1,000 sold = NT$20,000 loss", 
                        isCorrect: false, 
                        feedback: "‚ùå Check your CM calculation: 138 - 95 - 8 = 35, not 30." 
                    }
                ]
            },
            {
                id: 5,
                title: "üéüÔ∏è Exercise 4: Meal Voucher Program",
                badge: "üé´ Exercise 4: Multi-Product Analysis",
                points: 20,
                scenario: `
                    <strong>üìÖ Cash Flow Innovation</strong><br><br>
                    How-Dine launched a creative "10 Meal Vouchers for NT$4,800" program. This generates immediate cash flow and locks in future customers. In May 2020, 500 sets were sold. Analyze the financial impact.
                `,
                dataHtml: `
                    <table class="data-table">
                        <tr><th>Item</th><th>Details</th></tr>
                        <tr><td>Voucher Package Price</td><td>NT$4,800/set (contains 10 vouchers)</td></tr>
                        <tr><td>Redemption Options</td><td>Lobster meal (original NT$1,000) or Western set (original NT$600)</td></tr>
                        <tr><td>Lobster Meal Ingredient Cost</td><td>NT$600</td></tr>
                        <tr><td>Western Set Ingredient Cost</td><td>NT$300</td></tr>
                        <tr><td>Expected Redemption Mix</td><td>Lobster 40%, Western 60%</td></tr>
                        <tr><td>May 2020 Sales</td><td>500 sets</td></tr>
                    </table>
                `,
                question: "What is the estimated average redemption cost per voucher set? What is the contribution margin per set? How much total CM did 500 sets generate?",
                options: [
                    { 
                        text: "Redemption cost: NT$4,200/set; CM: NT$600/set; Total CM: NT$300,000", 
                        isCorrect: true, 
                        feedback: "‚úÖ <strong>Excellent Analysis!</strong><br><br>üìê Calculation:<br>‚Ä¢ Average cost per voucher = (40% √ó 600) + (60% √ó 300) = 240 + 180 = NT$420<br>‚Ä¢ Cost per set (10 vouchers) = 420 √ó 10 = <strong>NT$4,200</strong><br><br>‚Ä¢ CM per set = 4,800 - 4,200 = <strong>NT$600</strong><br><br>‚Ä¢ Total CM from 500 sets = 600 √ó 500 = <strong>NT$300,000</strong><br><br>üí° <strong>Cash Flow Impact:</strong> 500 sets √ó NT$4,800 = <strong>NT$2.4M immediate cash inflow!</strong> This NT$300K covers about 0.09 months of fixed costs (300K √∑ 3.32M), but the real value is the <strong>advance cash</strong> during a zero-revenue period." 
                    },
                    { 
                        text: "Redemption cost: NT$4,500/set; CM: NT$300/set; Total CM: NT$150,000", 
                        isCorrect: false, 
                        feedback: "‚ùå Wrong weighted average calculation. Cost per voucher = (40% √ó 600) + (60% √ó 300) = 420, not 450." 
                    },
                    { 
                        text: "Redemption cost: NT$4,800/set; CM: NT$0/set; Total CM: NT$0", 
                        isCorrect: false, 
                        feedback: "‚ùå Redemption cost is the INGREDIENT cost, not the original menu price! The package price (NT$4,800) is revenue, ingredient cost (NT$4,200) is the variable cost." 
                    },
                    { 
                        text: "Redemption cost: NT$3,600/set; CM: NT$1,200/set; Total CM: NT$600,000", 
                        isCorrect: false, 
                        feedback: "‚ùå Your weighted average is incorrect. Remember: 10 vouchers per set, each voucher costs (40% √ó 600) + (60% √ó 300) = NT$420." 
                    }
                ]
            }
        ];

        const game = {
            currentLevelIndex: 0,
            score: 0,
            attempts: {},
            
            init: function() {
                levels.forEach((_, idx) => { this.attempts[idx] = 0; });
                this.updateStats();
                this.renderLevel();
            },

            start: function() {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
                this.init();
            },

            renderLevel: function() {
                const level = levels[this.currentLevelIndex];
                const attemptNum = this.attempts[this.currentLevelIndex] + 1;
                const scorePercent = Math.max(20, 100 - (this.attempts[this.currentLevelIndex] * 20));
                
                document.getElementById('level-display').textContent = `${this.currentLevelIndex + 1} / ${levels.length}`;
                document.getElementById('level-badge').textContent = level.badge;
                document.getElementById('scenario-title').textContent = level.title;
                document.getElementById('scenario-text').innerHTML = level.scenario;
                document.getElementById('data-section').innerHTML = level.dataHtml;
                document.getElementById('question-text').textContent = level.question;
                
                document.getElementById('attempt-info').innerHTML = 
                    `üéØ Attempt: ${attemptNum} / Points Available: <strong>${scorePercent}%</strong> (${level.points * scorePercent / 100} pts)`;
                
                const progress = (this.currentLevelIndex / levels.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;

                const optionsGrid = document.getElementById('options-grid');
                optionsGrid.innerHTML = '';
                
                level.options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerHTML = `
                        <span class="option-letter">${String.fromCharCode(65+index)}</span>
                        <span>${opt.text}</span>
                    `;
                    btn.onclick = () => this.checkAnswer(index);
                    optionsGrid.appendChild(btn);
                });
            },

            checkAnswer: function(selectedIndex) {
                const level = levels[this.currentLevelIndex];
                const option = level.options[selectedIndex];
                const btns = document.querySelectorAll('.option-btn');

                btns.forEach(btn => btn.disabled = true);
                btns[selectedIndex].classList.add(option.isCorrect ? 'correct' : 'wrong');
                
                if (!option.isCorrect) {
                    level.options.forEach((opt, idx) => {
                        if (opt.isCorrect) btns[idx].classList.add('correct');
                    });
                    this.attempts[this.currentLevelIndex]++;
                }

                this.showFeedback(option.isCorrect, option.feedback, level.points);
            },

            showFeedback: function(isCorrect, message, maxPoints) {
                const overlay = document.getElementById('feedback-overlay');
                const icon = document.getElementById('feedback-icon');
                const title = document.getElementById('feedback-title');
                const scoreDiv = document.getElementById('feedback-score');
                const msg = document.getElementById('feedback-message');
                const btn = document.getElementById('feedback-btn');

                overlay.style.display = 'flex';
                
                if (isCorrect) {
                    const scorePercent = Math.max(20, 100 - (this.attempts[this.currentLevelIndex] * 20));
                    const earnedPoints = maxPoints * scorePercent / 100;
                    
                    icon.textContent = 'üéâ';
                    title.textContent = 'Correct!';
                    title.style.color = '#10b981';
                    scoreDiv.textContent = `+${earnedPoints} pts (${scorePercent}%)`;
                    scoreDiv.style.display = 'inline-block';
                    
                    this.score += earnedPoints;
                    this.updateStats();
                    
                    if (this.currentLevelIndex === levels.length - 1) {
                        btn.textContent = "üèÜ View Final Score";
                        btn.onclick = () => this.finishGame();
                    } else {
                        btn.textContent = "‚û°Ô∏è Next Exercise";
                        btn.onclick = () => {
                            overlay.style.display = 'none';
                            this.currentLevelIndex++;
                            this.renderLevel();
                        };
                    }
                } else {
                    icon.textContent = 'üí°';
                    title.textContent = 'Think Again!';
                    title.style.color = '#f59e0b';
                    scoreDiv.style.display = 'none';
                    
                    btn.textContent = "üîÑ Try Again";
                    btn.onclick = () => {
                        overlay.style.display = 'none';
                        this.renderLevel();
                    };
                }
                
                msg.innerHTML = message;
            },

            updateStats: function() {
                document.getElementById('score-display').textContent = Math.round(this.score);
            },

            finishGame: function() {
                const overlay = document.getElementById('feedback-overlay');
                const finalScore = Math.round(this.score);
                
                let grade, gradeClass, comment;
                
                if (finalScore >= 90) {
                    grade = 'S';
                    gradeClass = 'grade-S';
                    comment = 'üåü <strong>Strategic CFO Excellence!</strong><br><br>You demonstrated mastery of CVP analysis and understand how quantitative tools inform strategic decisions. You recognized that "People or Profit" is not always a binary choice ‚Äî sometimes preserving human capital creates long-term value that outweighs short-term costs. Chairman Yeh would be proud to have you on his team!';
                } else if (finalScore >= 80) {
                    grade = 'A';
                    gradeClass = 'grade-A';
                    comment = 'üëè <strong>Strong Financial Analyst!</strong><br><br>You have solid CVP skills and can evaluate different strategic scenarios. You understand that break-even analysis, cash burn rates, and contribution margins are essential tools for crisis decision-making. Keep developing your ability to connect numbers with strategic implications!';
                } else if (finalScore >= 60) {
                    grade = 'B';
                    gradeClass = 'grade-B';
                    comment = 'üìö <strong>Developing Analyst</strong><br><br>You grasp the fundamentals of CVP analysis but stumbled on some calculations. Review the relationship between contribution margin ratio and break-even points, and practice cash burn analysis under different scenarios. These are critical skills for any finance professional!';
                } else if (finalScore >= 40) {
                    grade = 'C';
                    gradeClass = 'grade-C';
                    comment = 'üìñ <strong>Needs More Practice</strong><br><br>CVP analysis requires careful attention to formulas and their applications. Focus on: (1) Break-even = Fixed Costs √∑ CM Ratio, (2) Cash runway = Cash √∑ Monthly burn, (3) CM = Price - Variable costs. Practice these fundamentals until they become second nature!';
                } else {
                    grade = 'F';
                    gradeClass = 'grade-F';
                    comment = 'üí™ <strong>Foundation Building Required</strong><br><br>Don\'t be discouraged! CVP analysis is fundamental but requires practice. Start by clearly distinguishing fixed vs. variable costs, then master the contribution margin concept. Once these click, the rest will follow. Every expert was once a beginner!';
                }
                
                overlay.innerHTML = `
                    <div class="feedback-card">
                        <span class="feedback-icon">üèÜ</span>
                        <h2 class="feedback-title" style="color:#fbbf24">Challenge Complete!</h2>
                        <div class="final-grade ${gradeClass}">${grade}</div>
                        <div class="score-breakdown">
                            <div class="score-item">
                                <div class="label">Final Score</div>
                                <div class="value">${finalScore}</div>
                            </div>
                            <div class="score-item">
                                <div class="label">Max Score</div>
                                <div class="value">100</div>
                            </div>
                            <div class="score-item">
                                <div class="label">Exercises</div>
                                <div class="value">${levels.length}/${levels.length}</div>
                            </div>
                        </div>
                        <div class="final-comment">${comment}</div>
                        <button class="next-btn" onclick="location.reload()">üîÑ Try Again</button>
                    </div>
                `;
            }
        };
    </script>
</body>
<!-- Music: Pachelbel Canon in D Major from Internet Archive (Public Domain) -->
</html>
