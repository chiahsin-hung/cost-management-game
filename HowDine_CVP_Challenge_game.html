<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçΩÔ∏è How-Dine Crisis: CVP Decision Challenge</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255,255,255,0.95);
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --gold: #fbbf24;
            --restaurant-red: #dc2626;
            --restaurant-gold: #d97706;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1; overflow: hidden;
        }

        .bg-animation span {
            position: absolute; display: block;
            width: 20px; height: 20px;
            background: rgba(255,255,255,0.1);
            animation: float 25s linear infinite;
            bottom: -150px; border-radius: 50%;
        }

        .bg-animation span:nth-child(1) { left: 25%; width: 80px; height: 80px; }
        .bg-animation span:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .bg-animation span:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .bg-animation span:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-duration: 18s; }
        .bg-animation span:nth-child(5) { left: 65%; width: 20px; height: 20px; }
        .bg-animation span:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .bg-animation span:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .bg-animation span:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .bg-animation span:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .bg-animation span:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-duration: 11s; }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
        }

        .game-container { max-width: 950px; margin: 0 auto; padding: 1.5rem; }

        .music-control {
            position: fixed; top: 20px; right: 20px;
            z-index: 1000; display: flex; gap: 10px;
        }

        .music-btn {
            background: white; border: none;
            width: 50px; height: 50px; border-radius: 50%;
            cursor: pointer; font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .music-btn:hover { transform: scale(1.1); }

        header {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .game-title { display: flex; align-items: center; gap: 1rem; }
        .game-title .logo { font-size: 2.5rem; }
        .game-title h1 {
            font-size: 1.4rem; font-weight: 900;
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .game-title p { font-size: 0.85rem; color: var(--text-muted); }

        .stats { display: flex; gap: 2rem; }
        .stat-item { text-align: center; }
        .stat-item .label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .stat-item .value { font-size: 2rem; font-weight: 900; color: var(--primary); }
        .stat-item .value.gold { color: var(--gold); }

        .progress-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .progress-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 500; }
        .progress-bar-bg { height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #ef4444, #ec4899, #8b5cf6);
            background-size: 300% 100%;
            animation: gradientMove 3s ease infinite;
            width: 0%; transition: width 0.5s ease; border-radius: 6px;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-badge {
            display: inline-flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; padding: 0.5rem 1rem;
            border-radius: 30px; font-size: 0.9rem; font-weight: 600; margin-bottom: 1rem;
        }

        .scenario-title {
            font-size: 1.6rem; font-weight: 900;
            color: var(--restaurant-red);
            margin-bottom: 1rem;
            display: flex; align-items: center; gap: 0.5rem;
        }

        .scenario-text {
            font-size: 1rem; line-height: 1.9;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 15px;
            border-left: 5px solid var(--accent);
        }

        .data-table {
            width: 100%; border-collapse: collapse;
            margin: 1.5rem 0; font-size: 0.9rem;
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            color: white; padding: 12px 15px;
            text-align: left; font-weight: 600;
        }

        .data-table td { padding: 12px 15px; border-bottom: 1px solid #e5e7eb; }
        .data-table tr:nth-child(even) { background: #f9fafb; }
        .data-table tr:hover { background: #fef3c7; }

        .question-box {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            padding: 1.5rem; border-radius: 15px;
            margin-top: 1.5rem; border: 2px solid var(--primary);
        }

        .question-text {
            font-size: 1.1rem; font-weight: 700;
            color: var(--primary); margin-bottom: 1.5rem;
            display: flex; align-items: flex-start; gap: 0.5rem;
        }

        .question-text::before { content: '‚ùì'; font-size: 1.5rem; }

        .attempt-info {
            display: inline-flex; align-items: center; gap: 0.5rem;
            background: white; padding: 0.5rem 1rem;
            border-radius: 20px; font-size: 0.85rem;
            margin-bottom: 1rem; color: var(--text-muted);
        }

        .options-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }

        .option-btn {
            background: white; border: 3px solid #e5e7eb;
            color: var(--text-dark); padding: 1.2rem 1.5rem;
            border-radius: 15px; cursor: pointer;
            transition: all 0.3s ease;
            text-align: left; font-size: 0.95rem;
            display: flex; align-items: flex-start; gap: 1rem;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: #f5f3ff;
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.2);
        }

        .option-btn .option-letter {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; width: 35px; height: 35px;
            border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            font-weight: 700; flex-shrink: 0;
        }

        .option-btn.correct { border-color: var(--success); background: #d1fae5; }
        .option-btn.correct .option-letter { background: var(--success); }
        .option-btn.wrong { border-color: var(--error); background: #fee2e2; }
        .option-btn.wrong .option-letter { background: var(--error); }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }

        .feedback-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
            padding: 1rem; overflow-y: auto;
        }

        .feedback-card {
            background: white; border-radius: 25px;
            padding: 2.5rem; max-width: 600px; width: 100%;
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; overflow-y: auto;
        }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .feedback-icon { font-size: 4rem; margin-bottom: 1rem; display: block; animation: bounce 0.5s ease; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .feedback-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 1rem; }

        .feedback-score {
            font-size: 1.1rem; color: var(--primary);
            margin-bottom: 1rem; padding: 0.5rem 1.5rem;
            background: #f3f4f6; border-radius: 30px; display: inline-block;
        }

        .feedback-message {
            font-size: 0.95rem; line-height: 1.8;
            color: var(--text-muted); margin-bottom: 2rem;
            text-align: left; padding: 1rem;
            background: #f9fafb; border-radius: 12px;
        }

        .next-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none;
            padding: 1rem 3rem; border-radius: 30px;
            font-size: 1.1rem; font-weight: 700;
            cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;
        }

        .next-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .intro-screen {
            min-height: 100vh; display: flex;
            align-items: center; justify-content: center; padding: 2rem;
        }

        .intro-card {
            background: var(--card-bg); border-radius: 30px;
            padding: 3rem; max-width: 750px;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .intro-logo { font-size: 5rem; margin-bottom: 1rem; animation: float-gentle 3s ease-in-out infinite; }

        @keyframes float-gentle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .intro-title {
            font-size: 2.2rem; font-weight: 900;
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 0.5rem;
        }

        .intro-subtitle { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; }

        .intro-desc {
            font-size: 0.95rem; line-height: 1.8;
            color: var(--text-dark); margin-bottom: 2rem;
            text-align: left; padding: 1.5rem;
            background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 15px;
        }

        .intro-rules { text-align: left; margin-bottom: 2rem; }
        .intro-rules h3 { color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .intro-rules ul { list-style: none; padding: 0; }
        .intro-rules li { padding: 0.5rem 0; padding-left: 2rem; position: relative; }
        .intro-rules li::before { content: '‚úì'; position: absolute; left: 0; color: var(--success); font-weight: bold; }

        .start-btn {
            background: linear-gradient(135deg, var(--restaurant-red), var(--restaurant-gold));
            color: white; border: none;
            padding: 1.2rem 4rem; border-radius: 40px;
            font-size: 1.3rem; font-weight: 700;
            cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
        }

        .start-btn:hover { transform: scale(1.08); }

        .final-grade { font-size: 4rem; font-weight: 900; margin: 1rem 0; }
        .grade-S { color: #fbbf24; }
        .grade-A { color: #10b981; }
        .grade-B { color: #3b82f6; }
        .grade-C { color: #f59e0b; }
        .grade-F { color: #ef4444; }

        .final-comment {
            font-size: 1rem; line-height: 1.8;
            padding: 1.5rem; background: #f9fafb;
            border-radius: 15px; margin: 1.5rem 0; text-align: left;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem; margin: 1.5rem 0;
        }

        .score-item {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 1rem; border-radius: 12px; text-align: center;
        }

        .score-item .label { font-size: 0.75rem; color: var(--text-muted); }
        .score-item .value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }

        #game-area { display: none; }

        @media (max-width: 768px) {
            .game-container { padding: 1rem; }
            header { flex-direction: column; text-align: center; }
            .stats { justify-content: center; }
            .game-title h1 { font-size: 1.1rem; }
            .intro-title { font-size: 1.5rem; }
            .scenario-title { font-size: 1.2rem; }
            .feedback-card { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="music-control">
        <button class="music-btn" id="music-toggle" onclick="toggleMusic()" title="Play/Pause Music">üîá</button>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://archive.org/download/PachelbelCanonInDMajor/Pachelbel_%20Canon%20-%20In%20D%20Major.mp3" type="audio/mpeg">
    </audio>

    <div id="intro-screen" class="intro-screen">
        <div class="intro-card">
            <div class="intro-logo">üçΩÔ∏è</div>
            <h1 class="intro-title">How-Dine Crisis: CVP Challenge</h1>
            <p class="intro-subtitle">MBA | Cost & Management Accounting Practice</p>
            
            <div class="intro-desc">
                <strong>üìñ Story Background:</strong><br>
                How-Dine Wedding Banquet Venue, founded in 2002, had established itself as a premium wedding banquet provider with NT$212 million annual revenue and 120 employees. Then COVID-19 struck in early 2020, devastating the wedding industry overnight. Revenue plummeted 48% to just NT$110 million. As CFO, you must use CVP analysis to navigate this crisis!
            </div>

            <div class="intro-rules">
                <h3>üìã Game Rules</h3>
                <ul>
                    <li>Complete <strong>5 exercises</strong> based on CVP analysis</li>
                    <li>First correct attempt earns <strong>100%</strong> of points</li>
                    <li>Second attempt: <strong>80%</strong>, third: <strong>60%</strong>, etc.</li>
                    <li><strong>Calculate first</strong> before answering!</li>
                    <li>üéÅ Complete all to unlock <strong>Bonus Game!</strong></li>
                </ul>
            </div>

            <button class="start-btn" onclick="game.start()">üöÄ Start Challenge</button>
        </div>
    </div>

    <div id="game-area" class="game-container">
        <header>
            <div class="game-title">
                <span class="logo">üçΩÔ∏è</span>
                <div>
                    <h1>How-Dine Crisis: CVP Challenge</h1>
                    <p>People or Profit? Make strategic decisions!</p>
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="label">Level</div>
                    <div class="value" id="level-display">1 / 5</div>
                </div>
                <div class="stat-item">
                    <div class="label">Score</div>
                    <div class="value gold" id="score-display">0</div>
                </div>
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-header">
                <span>üéØ Progress</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <div class="card" id="level-card">
            <span class="level-badge" id="level-badge">üìä Exercise 1</span>
            <h2 class="scenario-title" id="scenario-title">Break-Even Analysis</h2>
            <div class="scenario-text" id="scenario-text"></div>
            <div id="data-section"></div>
            <div class="question-box">
                <div class="attempt-info" id="attempt-info">üéØ Attempt: 1 / Points: 100%</div>
                <p class="question-text" id="question-text"></p>
                <div class="options-grid" id="options-grid"></div>
            </div>
        </div>
    </div>

    <div class="feedback-overlay" id="feedback-overlay">
        <div class="feedback-card">
            <span class="feedback-icon" id="feedback-icon">üéâ</span>
            <h2 class="feedback-title" id="feedback-title">Correct!</h2>
            <div class="feedback-score" id="feedback-score">+20 points</div>
            <p class="feedback-message" id="feedback-message"></p>
            <button class="next-btn" id="feedback-btn">Next</button>
        </div>
    </div>

    <script>
        // Music Control
        var bgMusic = document.getElementById('bgMusic');
        var musicBtn = document.getElementById('music-toggle');
        var musicPlaying = false;

        function toggleMusic() {
            if (musicPlaying) {
                bgMusic.pause();
                musicBtn.textContent = 'üîá';
            } else {
                bgMusic.volume = 0.4;
                bgMusic.play();
                musicBtn.textContent = 'üîä';
            }
            musicPlaying = !musicPlaying;
        }

        // Level Data
        var levels = [
            {
                id: 1,
                title: "üè® Exercise 1: Break-Even Point Analysis",
                badge: "üìä Exercise 1: Break-Even Analysis",
                points: 20,
                scenario: "<strong>üìÖ March 2020 - The Crisis Begins</strong><br><br>You are How-Dine's CFO. The pandemic has devastated the wedding industry. Nearly all bookings from late January through July were cancelled. You need to analyze the financial situation to advise Chairman Yeh on critical decisions.",
                dataHtml: '<table class="data-table"><tr><th>Item</th><th>Amount (NT$)</th></tr><tr><td>Annual Revenue (2018 Baseline)</td><td>$212,050,000</td></tr><tr><td>Variable Costs</td><td>~38% of revenue</td></tr><tr><td>Contribution Margin Ratio</td><td>62%</td></tr><tr><td>Annual Fixed Costs</td><td>$108,000,000</td></tr><tr><td>2020 Projected Revenue</td><td>$110,000,000 (48% decline)</td></tr></table>',
                question: "What is the annual break-even revenue for How-Dine? With 2020 projected revenue of NT$110M, what is the expected annual loss?",
                options: [
                    { text: "Break-even: ~NT$174M; Annual loss: ~NT$40M", isCorrect: true, feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê Calculation:<br>‚Ä¢ Break-even Revenue = Fixed Costs √∑ CM Ratio<br>= 108,000,000 √∑ 62% = <strong>NT$174,193,548 ‚âà NT$174M</strong><br><br>‚Ä¢ Annual Loss = Fixed Costs - (Revenue √ó CM Ratio)<br>= 108,000,000 - (110,000,000 √ó 62%)<br>= 108,000,000 - 68,200,000 = <strong>NT$39,800,000 ‚âà NT$40M</strong><br><br>‚Ä¢ Monthly Loss ‚âà <strong>NT$3.32M/month</strong>" },
                    { text: "Break-even: ~NT$284M; Annual loss: ~NT$68M", isCorrect: false, feedback: "‚ùå You divided by Variable Cost Ratio (38%) instead of Contribution Margin Ratio (62%)." },
                    { text: "Break-even: ~NT$174M; Annual loss: ~NT$102M", isCorrect: false, feedback: "‚ùå Break-even is correct, but loss calculation is wrong. Loss = Fixed Costs - Contribution Margin." },
                    { text: "Break-even: ~NT$108M; Annual loss: ~NT$0", isCorrect: false, feedback: "‚ùå Fixed costs ‚â† Break-even point! Must divide by CM ratio." }
                ]
            },
            {
                id: 2,
                title: "‚ö° Exercise 2: Scenario A - Layoffs + Salary Cut",
                badge: "üíº Exercise 2A: Cash Burn Analysis",
                points: 20,
                scenario: "<strong>üìÖ Strategic Planning Meeting</strong><br><br>Chairman Yeh is considering different strategies. You need to analyze <strong>Scenario A: 50% Layoffs + 20% Salary Reduction</strong> to understand how long the company can survive.",
                dataHtml: '<table class="data-table"><tr><th>Item</th><th>Original / Calculation</th></tr><tr><td>Cash Reserves</td><td>NT$72,000,000</td></tr><tr><td>Original Monthly Fixed Costs</td><td>NT$9,000,000</td></tr><tr><td>„ÄÄ‚îú Full-time Salaries (45 staff)</td><td>NT$4,500,000/month</td></tr><tr><td>„ÄÄ‚îú Rent</td><td>NT$1,250,000/month</td></tr><tr><td>„ÄÄ‚îú Utilities</td><td>NT$800,000/month</td></tr><tr><td>„ÄÄ‚îî Other Fixed Expenses</td><td>NT$2,450,000/month</td></tr><tr><td>Monthly Contribution Margin (2020)</td><td>110M √∑ 12 √ó 62% = NT$5,683,333</td></tr><tr><td colspan="2"><strong>Scenario A:</strong> 50% layoffs ‚Üí salary = $2.25M; then 20% cut ‚Üí $1.8M; Severance = $13.5M</td></tr></table>',
                question: "Under Scenario A, what is the new monthly loss and how many months can the cash reserves last (after paying severance)?",
                options: [
                    { text: "Monthly loss: ~NT$620K; Cash runway: ~95 months", isCorrect: true, feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê Calculation:<br>‚Ä¢ New monthly fixed costs = 1,800,000 + 1,250,000 + 800,000 + 2,450,000 = <strong>NT$6,300,000</strong><br>‚Ä¢ Monthly loss = 6,300,000 - 5,683,333 = <strong>NT$616,667 ‚âà NT$620K</strong><br>‚Ä¢ Cash after severance = 72,000,000 - 13,500,000 = NT$58,500,000<br>‚Ä¢ Cash runway = 58,500,000 √∑ 616,667 ‚âà <strong>95 months (~8 years)</strong>" },
                    { text: "Monthly loss: ~NT$620K; Cash runway: ~117 months", isCorrect: false, feedback: "‚ùå You forgot to deduct the one-time severance payment of NT$13.5M!" },
                    { text: "Monthly loss: ~NT$2.7M; Cash runway: ~22 months", isCorrect: false, feedback: "‚ùå You didn't apply the salary reductions correctly." },
                    { text: "Monthly loss: ~NT$1.07M; Cash runway: ~55 months", isCorrect: false, feedback: "‚ùå Check your fixed cost calculation." }
                ]
            },
            {
                id: 3,
                title: "ü§ù Exercise 2: Scenarios C & D Comparison",
                badge: "üíº Exercise 2B: Strategy Comparison",
                points: 20,
                scenario: "<strong>üìÖ The People-First Options</strong><br><br>Now analyze the two options that prioritize employee retention:<br><strong>Scenario C:</strong> No Layoffs + 20% Salary Reduction<br><strong>Scenario D:</strong> No Layoffs + No Salary Cuts",
                dataHtml: '<table class="data-table"><tr><th>Scenario</th><th>Monthly Fixed Costs</th><th>Formula</th></tr><tr><td>C: No Layoffs + 20% Cut</td><td>Salaries: 4.5M √ó 80% = NT$3.6M</td><td>3.6M + 1.25M + 0.8M + 2.45M</td></tr><tr><td>D: No Layoffs + Full Salary</td><td>Salaries: NT$4.5M (unchanged)</td><td>4.5M + 1.25M + 0.8M + 2.45M</td></tr><tr><td colspan="3">Monthly CM = NT$5,683,333 | Cash Reserves = NT$72,000,000</td></tr></table>',
                question: "Calculate the monthly loss and cash runway for both Scenario C and D. Which statement is correct?",
                options: [
                    { text: "C: Loss ~NT$2.42M, ~30 months; D: Loss ~NT$3.32M, ~22 months", isCorrect: true, feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê <strong>Scenario C:</strong><br>‚Ä¢ Fixed costs = 3.6M + 1.25M + 0.8M + 2.45M = NT$8.1M<br>‚Ä¢ Monthly loss = 8.1M - 5.68M = <strong>NT$2.42M</strong><br>‚Ä¢ Runway = 72M √∑ 2.42M ‚âà <strong>30 months</strong><br><br>üìê <strong>Scenario D:</strong><br>‚Ä¢ Fixed costs = NT$9M<br>‚Ä¢ Monthly loss = 9M - 5.68M = <strong>NT$3.32M</strong><br>‚Ä¢ Runway = 72M √∑ 3.32M ‚âà <strong>22 months</strong>" },
                    { text: "C: Loss ~NT$3.32M, ~22 months; D: Loss ~NT$2.42M, ~30 months", isCorrect: false, feedback: "‚ùå You swapped the scenarios! D has higher costs than C." },
                    { text: "C: Loss ~NT$1.52M, ~47 months; D: Loss ~NT$2.42M, ~30 months", isCorrect: false, feedback: "‚ùå Check Scenario C's fixed cost calculation." },
                    { text: "C: Loss ~NT$2.42M, ~30 months; D: Loss ~NT$4.22M, ~17 months", isCorrect: false, feedback: "‚ùå Scenario D's loss calculation is wrong." }
                ]
            },
            {
                id: 4,
                title: "üç± Exercise 3: NT$138 Bento Box Analysis",
                badge: "ü•° Exercise 3: New Product CVP",
                points: 20,
                scenario: "<strong>üìÖ Innovation During Crisis</strong><br><br>To keep employees working and maintain customer relationships, How-Dine considers launching a NT$138 premium bento box program.",
                dataHtml: '<table class="data-table"><tr><th>Item</th><th>Amount</th></tr><tr><td>Selling Price</td><td>NT$138/unit</td></tr><tr><td>Ingredient Cost</td><td>~NT$95/unit</td></tr><tr><td>Packaging Cost</td><td>~NT$8/unit</td></tr><tr><td>Additional Monthly Fixed Costs</td><td>~NT$50,000</td></tr></table>',
                question: "What is the contribution margin per bento box? How many must be sold monthly to break even? If only 1,000 are sold, what is the program's P/L?",
                options: [
                    { text: "CM: NT$35/box; Break-even: 1,429 boxes; 1,000 sold = NT$15,000 loss", isCorrect: true, feedback: "‚úÖ <strong>Correct!</strong><br><br>üìê Calculation:<br>‚Ä¢ CM = 138 - (95 + 8) = <strong>NT$35/box</strong><br>‚Ä¢ Break-even = 50,000 √∑ 35 = <strong>1,429 boxes</strong><br>‚Ä¢ If 1,000 sold: (1,000 √ó 35) - 50,000 = <strong>-NT$15,000</strong><br><br>üí° This loses money but keeps employees working and maintains brand exposure!" },
                    { text: "CM: NT$43/box; Break-even: 1,163 boxes; 1,000 sold = NT$7,000 loss", isCorrect: false, feedback: "‚ùå You forgot packaging cost! Variable cost = 95 + 8 = NT$103" },
                    { text: "CM: NT$35/box; Break-even: 2,857 boxes; 1,000 sold = NT$65,000 loss", isCorrect: false, feedback: "‚ùå CM is correct, but break-even calculation is wrong." },
                    { text: "CM: NT$30/box; Break-even: 1,667 boxes; 1,000 sold = NT$20,000 loss", isCorrect: false, feedback: "‚ùå Check your CM calculation: 138 - 95 - 8 = 35" }
                ]
            },
            {
                id: 5,
                title: "üéüÔ∏è Exercise 4: Meal Voucher Program",
                badge: "üé´ Exercise 4: Multi-Product Analysis",
                points: 20,
                scenario: "<strong>üìÖ Cash Flow Innovation</strong><br><br>How-Dine launched a \"10 Meal Vouchers for NT$4,800\" program. This generates immediate cash flow. In May 2020, 500 sets were sold.",
                dataHtml: '<table class="data-table"><tr><th>Item</th><th>Details</th></tr><tr><td>Voucher Package Price</td><td>NT$4,800/set (10 vouchers)</td></tr><tr><td>Redemption Options</td><td>Lobster meal (original NT$1,000) or Western set (original NT$600)</td></tr><tr><td>Lobster Meal Ingredient Cost</td><td>NT$600</td></tr><tr><td>Western Set Ingredient Cost</td><td>NT$300</td></tr><tr><td>Expected Redemption Mix</td><td>Lobster 40%, Western 60%</td></tr><tr><td>May 2020 Sales</td><td>500 sets</td></tr></table>',
                question: "What is the estimated average redemption cost per voucher set? What is the contribution margin per set? How much total CM did 500 sets generate?",
                options: [
                    { text: "Redemption cost: NT$4,200/set; CM: NT$600/set; Total CM: NT$300,000", isCorrect: true, feedback: "‚úÖ <strong>Excellent!</strong><br><br>üìê Calculation:<br>‚Ä¢ Avg cost per voucher = (40% √ó 600) + (60% √ó 300) = NT$420<br>‚Ä¢ Cost per set (10 vouchers) = 420 √ó 10 = <strong>NT$4,200</strong><br>‚Ä¢ CM per set = 4,800 - 4,200 = <strong>NT$600</strong><br>‚Ä¢ Total CM = 600 √ó 500 = <strong>NT$300,000</strong><br><br>üí° Plus <strong>NT$2.4M immediate cash inflow!</strong>" },
                    { text: "Redemption cost: NT$4,500/set; CM: NT$300/set; Total CM: NT$150,000", isCorrect: false, feedback: "‚ùå Wrong weighted average. Cost = (40% √ó 600) + (60% √ó 300) = NT$420/voucher" },
                    { text: "Redemption cost: NT$4,800/set; CM: NT$0/set; Total CM: NT$0", isCorrect: false, feedback: "‚ùå Redemption cost is ingredient cost, not original menu price!" },
                    { text: "Redemption cost: NT$3,600/set; CM: NT$1,200/set; Total CM: NT$600,000", isCorrect: false, feedback: "‚ùå Check your weighted average calculation." }
                ]
            }
        ];

        // Game Logic
        var game = {
            currentLevelIndex: 0,
            score: 0,
            attempts: {},
            
            init: function() {
                for (var i = 0; i < levels.length; i++) {
                    this.attempts[i] = 0;
                }
                this.updateStats();
                this.renderLevel();
            },

            start: function() {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
                this.init();
            },

            renderLevel: function() {
                var level = levels[this.currentLevelIndex];
                var attemptNum = this.attempts[this.currentLevelIndex] + 1;
                var scorePercent = Math.max(20, 100 - (this.attempts[this.currentLevelIndex] * 20));
                
                document.getElementById('level-display').textContent = (this.currentLevelIndex + 1) + ' / ' + levels.length;
                document.getElementById('level-badge').textContent = level.badge;
                document.getElementById('scenario-title').textContent = level.title;
                document.getElementById('scenario-text').innerHTML = level.scenario;
                document.getElementById('data-section').innerHTML = level.dataHtml;
                document.getElementById('question-text').textContent = level.question;
                
                document.getElementById('attempt-info').innerHTML = 'üéØ Attempt: ' + attemptNum + ' / Points: <strong>' + scorePercent + '%</strong> (' + (level.points * scorePercent / 100) + ' pts)';
                
                var progress = (this.currentLevelIndex / levels.length) * 100;
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-text').textContent = Math.round(progress) + '%';

                var optionsGrid = document.getElementById('options-grid');
                optionsGrid.innerHTML = '';
                
                var self = this;
                level.options.forEach(function(opt, index) {
                    var btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerHTML = '<span class="option-letter">' + String.fromCharCode(65+index) + '</span><span>' + opt.text + '</span>';
                    btn.onclick = function() { self.checkAnswer(index); };
                    optionsGrid.appendChild(btn);
                });
            },

            checkAnswer: function(selectedIndex) {
                var level = levels[this.currentLevelIndex];
                var option = level.options[selectedIndex];
                var btns = document.querySelectorAll('.option-btn');

                for (var i = 0; i < btns.length; i++) {
                    btns[i].disabled = true;
                }

                btns[selectedIndex].classList.add(option.isCorrect ? 'correct' : 'wrong');
                
                if (!option.isCorrect) {
                    for (var j = 0; j < level.options.length; j++) {
                        if (level.options[j].isCorrect) {
                            btns[j].classList.add('correct');
                        }
                    }
                    this.attempts[this.currentLevelIndex]++;
                }

                this.showFeedback(option.isCorrect, option.feedback, level.points);
            },

            showFeedback: function(isCorrect, message, maxPoints) {
                var overlay = document.getElementById('feedback-overlay');
                var icon = document.getElementById('feedback-icon');
                var title = document.getElementById('feedback-title');
                var scoreDiv = document.getElementById('feedback-score');
                var msg = document.getElementById('feedback-message');
                var btn = document.getElementById('feedback-btn');
                var self = this;

                overlay.style.display = 'flex';
                
                if (isCorrect) {
                    var scorePercent = Math.max(20, 100 - (this.attempts[this.currentLevelIndex] * 20));
                    var earnedPoints = maxPoints * scorePercent / 100;
                    
                    icon.textContent = 'üéâ';
                    title.textContent = 'Correct!';
                    title.style.color = '#10b981';
                    scoreDiv.textContent = '+' + earnedPoints + ' pts (' + scorePercent + '%)';
                    scoreDiv.style.display = 'inline-block';
                    
                    this.score += earnedPoints;
                    this.updateStats();
                    
                    if (this.currentLevelIndex === levels.length - 1) {
                        btn.textContent = "üèÜ View Final Score";
                        btn.onclick = function() { self.finishGame(); };
                    } else {
                        btn.textContent = "‚û°Ô∏è Next Exercise";
                        btn.onclick = function() {
                            overlay.style.display = 'none';
                            self.currentLevelIndex++;
                            self.renderLevel();
                        };
                    }
                } else {
                    icon.textContent = 'üí°';
                    title.textContent = 'Think Again!';
                    title.style.color = '#f59e0b';
                    scoreDiv.style.display = 'none';
                    
                    btn.textContent = "üîÑ Try Again";
                    btn.onclick = function() {
                        overlay.style.display = 'none';
                        self.renderLevel();
                    };
                }
                
                msg.innerHTML = message;
            },

            updateStats: function() {
                document.getElementById('score-display').textContent = Math.round(this.score);
            },

            finishGame: function() {
                var finalScore = Math.round(this.score);
                var grade, gradeClass, comment;
                
                if (finalScore >= 90) {
                    grade = 'S'; gradeClass = 'grade-S';
                    comment = 'üåü <strong>Strategic CFO Excellence!</strong><br><br>You demonstrated mastery of CVP analysis. Chairman Yeh would be proud!';
                } else if (finalScore >= 80) {
                    grade = 'A'; gradeClass = 'grade-A';
                    comment = 'üëè <strong>Strong Financial Analyst!</strong><br><br>You have solid CVP skills and can evaluate different strategic scenarios.';
                } else if (finalScore >= 60) {
                    grade = 'B'; gradeClass = 'grade-B';
                    comment = 'üìö <strong>Developing Analyst</strong><br><br>You grasp the fundamentals but need more practice with some calculations.';
                } else if (finalScore >= 40) {
                    grade = 'C'; gradeClass = 'grade-C';
                    comment = 'üìñ <strong>Needs More Practice</strong><br><br>Focus on: Break-even = Fixed Costs √∑ CM Ratio, and Cash runway = Cash √∑ Monthly burn.';
                } else {
                    grade = 'F'; gradeClass = 'grade-F';
                    comment = 'üí™ <strong>Foundation Building Required</strong><br><br>Start by distinguishing fixed vs. variable costs, then master contribution margin.';
                }
                
                var overlay = document.getElementById('feedback-overlay');
                overlay.innerHTML = '<div class="feedback-card">' +
                    '<span class="feedback-icon">üèÜ</span>' +
                    '<h2 class="feedback-title" style="color:#fbbf24">Challenge Complete!</h2>' +
                    '<div class="final-grade ' + gradeClass + '">' + grade + '</div>' +
                    '<div class="score-breakdown">' +
                    '<div class="score-item"><div class="label">Final Score</div><div class="value">' + finalScore + '</div></div>' +
                    '<div class="score-item"><div class="label">Max Score</div><div class="value">100</div></div>' +
                    '<div class="score-item"><div class="label">Exercises</div><div class="value">' + levels.length + '/' + levels.length + '</div></div>' +
                    '</div>' +
                    '<div class="final-comment">' + comment + '</div>' +
                    '<div style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">' +
                    '<button class="next-btn" onclick="location.reload()">üîÑ Try Again</button>' +
                    '<button class="next-btn" style="background:linear-gradient(135deg, #10b981, #059669);" onclick="startBonusGame()">üéÆ Bonus Game!</button>' +
                    '</div>' +
                    '<p style="margin-top:1rem; font-size:0.85rem; color:#6b7280;">üéÅ Reward: 1945 Air Force Style Shooter!</p>' +
                    '</div>';
            }
        };

        // ========================================
        // üéÆ BONUS GAME: 1945 Air Force Shooter
        // ========================================
        function startBonusGame() {
            if (bgMusic) bgMusic.pause();
            
            var gameHTML = '<style>' +
                '.game-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Poppins,sans-serif;overflow:hidden}' +
                '.game-header{position:absolute;top:20px;left:0;right:0;display:flex;justify-content:space-around;padding:0 20px;z-index:100}' +
                '.game-stat{background:rgba(0,0,0,0.5);padding:10px 20px;border-radius:10px;color:white;font-weight:bold}' +
                '.game-stat span{color:#fbbf24}' +
                '#gameCanvas{border:3px solid #fbbf24;border-radius:10px;box-shadow:0 0 30px rgba(251,191,36,0.3);max-width:100%;max-height:80vh}' +
                '.game-intro{text-align:center;color:white;padding:2rem}' +
                '.game-intro h1{font-size:2.5rem;color:#fbbf24;margin-bottom:1rem;text-shadow:0 0 20px rgba(251,191,36,0.5)}' +
                '.game-intro p{font-size:1.1rem;margin-bottom:0.5rem;color:#a0aec0}' +
                '.game-intro .controls{background:rgba(255,255,255,0.1);padding:1.5rem;border-radius:15px;margin:1.5rem 0}' +
                '.game-intro .controls h3{color:#10b981;margin-bottom:1rem}' +
                '.start-game-btn{background:linear-gradient(135deg,#ef4444,#dc2626);color:white;border:none;padding:1rem 3rem;font-size:1.3rem;font-weight:bold;border-radius:30px;cursor:pointer;margin:0.5rem}' +
                '.start-game-btn:hover{transform:scale(1.05)}' +
                '.back-btn{position:absolute;top:20px;left:20px;background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;z-index:1000}' +
                '.back-btn:hover{background:rgba(255,255,255,0.3)}' +
                '.game-over-screen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);padding:3rem;border-radius:20px;text-align:center;color:white;z-index:1000}' +
                '.game-over-screen h2{font-size:2.5rem;color:#ef4444;margin-bottom:1rem}' +
                '.game-over-screen .final-score{font-size:3rem;color:#fbbf24;margin:1rem 0}' +
                '</style>' +
                '<div class="game-screen" id="gameScreen">' +
                '<button class="back-btn" onclick="location.reload()">‚Üê Back to CVP</button>' +
                '<div class="game-intro" id="gameIntro">' +
                '<h1>‚úàÔ∏è 1945 AIR FORCE ‚úàÔ∏è</h1>' +
                '<p>üéÅ CVP Challenge Bonus Reward!</p>' +
                '<div class="controls">' +
                '<h3>üéÆ Controls</h3>' +
                '<p>‚¨ÖÔ∏è ‚û°Ô∏è Arrow Keys or Touch to Move</p>' +
                '<p>üî´ Auto-Fire Enabled</p>' +
                '<p>üí• Destroy enemies to score!</p>' +
                '<p>‚ù§Ô∏è You have 3 lives</p>' +
                '</div>' +
                '<button class="start-game-btn" onclick="initShooterGame()">üöÄ START MISSION</button>' +
                '</div>' +
                '<canvas id="gameCanvas" style="display:none;"></canvas>' +
                '<div class="game-header" id="gameHeader" style="display:none;">' +
                '<div class="game-stat">SCORE: <span id="shooterScore">0</span></div>' +
                '<div class="game-stat">LIVES: <span id="shooterLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>' +
                '<div class="game-stat">WAVE: <span id="shooterWave">1</span></div>' +
                '</div>' +
                '</div>';
            
            document.body.innerHTML = gameHTML;
        }

        function initShooterGame() {
            document.getElementById('gameIntro').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameHeader').style.display = 'flex';
            
            var canvas = document.getElementById('gameCanvas');
            var ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 600;
            
            var gs = {
                score: 0, lives: 3, wave: 1, gameOver: false,
                player: { x: 180, y: 520, w: 40, h: 50, speed: 6 },
                bullets: [], enemies: [], enemyBullets: [], explosions: [],
                lastShot: 0, shootInt: 150, spawnTimer: 0,
                keys: { left: false, right: false }
            };
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                var rect = canvas.getBoundingClientRect();
                gs.player.x = ((e.touches[0].clientX - rect.left) / rect.width) * canvas.width - gs.player.w/2;
            });
            
            document.onkeydown = function(e) {
                if (e.key === 'ArrowLeft') gs.keys.left = true;
                if (e.key === 'ArrowRight') gs.keys.right = true;
            };
            document.onkeyup = function(e) {
                if (e.key === 'ArrowLeft') gs.keys.left = false;
                if (e.key === 'ArrowRight') gs.keys.right = false;
            };
            
            function drawPlayer() {
                var p = gs.player;
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.moveTo(p.x + p.w/2, p.y);
                ctx.lineTo(p.x + p.w, p.y + p.h);
                ctx.lineTo(p.x, p.y + p.h);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#60a5fa';
                ctx.fillRect(p.x - 10, p.y + 25, p.w + 20, 10);
                ctx.fillStyle = '#fbbf24';
                ctx.beginPath();
                ctx.arc(p.x + p.w/2, p.y + 20, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#f97316';
                ctx.fillRect(p.x + 12, p.y + p.h, 6, 8 + Math.random() * 5);
                ctx.fillRect(p.x + p.w - 18, p.y + p.h, 6, 8 + Math.random() * 5);
            }
            
            function drawEnemy(e) {
                ctx.fillStyle = e.boss ? '#7c3aed' : '#ef4444';
                ctx.beginPath();
                ctx.moveTo(e.x + e.w/2, e.y + e.h);
                ctx.lineTo(e.x + e.w, e.y);
                ctx.lineTo(e.x, e.y);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = e.boss ? '#8b5cf6' : '#f87171';
                ctx.fillRect(e.x - 5, e.y + 10, e.w + 10, 8);
            }
            
            function drawBullet(b, enemy) {
                ctx.fillStyle = enemy ? '#ef4444' : '#fbbf24';
                ctx.shadowColor = ctx.fillStyle;
                ctx.shadowBlur = 8;
                ctx.fillRect(b.x, b.y, b.w, b.h);
                ctx.shadowBlur = 0;
            }
            
            function drawExplosion(exp) {
                ctx.globalAlpha = exp.life / 30;
                var g = ctx.createRadialGradient(exp.x, exp.y, 0, exp.x, exp.y, exp.r);
                g.addColorStop(0, '#fbbf24');
                g.addColorStop(0.5, '#f97316');
                g.addColorStop(1, '#ef4444');
                ctx.fillStyle = g;
                ctx.beginPath();
                ctx.arc(exp.x, exp.y, exp.r, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
            
            function spawnEnemy() {
                var boss = Math.random() < 0.1 && gs.wave > 1;
                gs.enemies.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -50, w: boss ? 60 : 35, h: boss ? 50 : 40,
                    speed: boss ? 1 : 1.5 + gs.wave * 0.3,
                    hp: boss ? 5 : 1, boss: boss, shootTimer: 0
                });
            }
            
            function hit(a, b) {
                return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
            }
            
            function updateUI() {
                document.getElementById('shooterScore').textContent = gs.score;
                document.getElementById('shooterLives').textContent = '‚ù§Ô∏è'.repeat(Math.max(0, gs.lives));
                document.getElementById('shooterWave').textContent = gs.wave;
            }
            
            function showGameOver() {
                var div = document.createElement('div');
                div.className = 'game-over-screen';
                div.innerHTML = '<h2>üí• GAME OVER üí•</h2>' +
                    '<p>Your Score:</p>' +
                    '<div class="final-score">' + gs.score + '</div>' +
                    '<p style="color:#a0aec0;">Wave: ' + gs.wave + '</p><br>' +
                    '<button class="start-game-btn" onclick="initShooterGame()">üîÑ Play Again</button>' +
                    '<button class="start-game-btn" onclick="location.reload()" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);">üìä Back to CVP</button>';
                document.getElementById('gameScreen').appendChild(div);
            }
            
            function loop() {
                if (gs.gameOver) return;
                
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                for (var i = 0; i < 50; i++) {
                    ctx.fillRect((i * 37 + Date.now() * 0.01) % canvas.width, (i * 53 + Date.now() * 0.05) % canvas.height, 1, 1);
                }
                
                if (gs.keys.left) gs.player.x -= gs.player.speed;
                if (gs.keys.right) gs.player.x += gs.player.speed;
                gs.player.x = Math.max(0, Math.min(canvas.width - gs.player.w, gs.player.x));
                
                var now = Date.now();
                if (now - gs.lastShot > gs.shootInt) {
                    gs.bullets.push({ x: gs.player.x + gs.player.w/2 - 3, y: gs.player.y, w: 6, h: 15, speed: 10 });
                    gs.lastShot = now;
                }
                
                gs.spawnTimer++;
                if (gs.spawnTimer > Math.max(30, 60 - gs.wave * 5)) {
                    spawnEnemy();
                    gs.spawnTimer = 0;
                }
                
                gs.bullets = gs.bullets.filter(function(b) { b.y -= b.speed; return b.y > -20; });
                gs.enemyBullets = gs.enemyBullets.filter(function(b) { b.y += b.speed; return b.y < canvas.height + 20; });
                
                gs.enemies = gs.enemies.filter(function(e) {
                    e.y += e.speed;
                    e.shootTimer++;
                    if (e.shootTimer > 100 && Math.random() < 0.02) {
                        gs.enemyBullets.push({ x: e.x + e.w/2 - 3, y: e.y + e.h, w: 6, h: 12, speed: 4 });
                        e.shootTimer = 0;
                    }
                    if (e.y > canvas.height) return false;
                    
                    for (var i = gs.bullets.length - 1; i >= 0; i--) {
                        if (hit(gs.bullets[i], e)) {
                            gs.bullets.splice(i, 1);
                            e.hp--;
                            if (e.hp <= 0) {
                                gs.score += e.boss ? 500 : 100;
                                gs.explosions.push({ x: e.x + e.w/2, y: e.y + e.h/2, r: e.boss ? 50 : 30, life: 30 });
                                if (gs.score >= gs.wave * 1000) gs.wave++;
                                return false;
                            }
                        }
                    }
                    
                    if (hit(e, { x: gs.player.x, y: gs.player.y, w: gs.player.w, h: gs.player.h })) {
                        gs.lives--;
                        gs.explosions.push({ x: e.x + e.w/2, y: e.y + e.h/2, r: 40, life: 30 });
                        if (gs.lives <= 0) { gs.gameOver = true; showGameOver(); }
                        return false;
                    }
                    return true;
                });
                
                gs.enemyBullets = gs.enemyBullets.filter(function(b) {
                    if (hit(b, { x: gs.player.x, y: gs.player.y, w: gs.player.w, h: gs.player.h })) {
                        gs.lives--;
                        if (gs.lives <= 0) { gs.gameOver = true; showGameOver(); }
                        return false;
                    }
                    return true;
                });
                
                gs.explosions = gs.explosions.filter(function(exp) { exp.life--; exp.r += 2; return exp.life > 0; });
                
                gs.bullets.forEach(function(b) { drawBullet(b, false); });
                gs.enemyBullets.forEach(function(b) { drawBullet(b, true); });
                gs.enemies.forEach(function(e) { drawEnemy(e); });
                gs.explosions.forEach(function(e) { drawExplosion(e); });
                drawPlayer();
                
                updateUI();
                requestAnimationFrame(loop);
            }
            
            loop();
        }
    </script>
</body>
</html>
